# K线数据问题排查指南

当遇到前端无法获取 K 线数据的问题时，可以按照以下步骤进行诊断和修复。

## 🔧 快速修复

### 使用内置诊断工具

1. **打开诊断工具**
   - 访问交易分析页面 `/round-pnl`
   - 在页面右下角找到"K线诊断"按钮
   - 点击打开诊断面板

2. **运行诊断**
   - 点击"运行诊断"按钮
   - 查看诊断结果，重点关注：
     - ❌ 红色错误：需要立即处理的问题
     - ⚠️ 黄色警告：可能影响性能或功能
     - ✅ 绿色成功：一切正常

3. **一键自动修复**
   - 点击"自动修复"按钮
   - 系统会自动：
     - 重置缓存服务
     - 切换到在线模式
     - 重新加载基础数据

## 🐛 常见问题及解决方案

### 问题 1: 离线模式被意外启用

**症状**: 控制台显示"离线模式"，无法获取新数据

**解决方案**:
```javascript
// 通过诊断工具点击"在线模式"按钮
// 或手动执行：
klineCacheService.setOfflineMode(false);
```

### 问题 2: 缓存数据过期或损坏

**症状**: 返回空数组或旧数据

**解决方案**:
- 点击"清空缓存"或"完全重置"
- 重新加载页面

### 问题 3: API 服务器连接失败

**症状**: 诊断显示"API连接"错误

**检查步骤**:
1. 确认后端服务正在运行
2. 检查网络连接
3. 查看浏览器控制台错误信息

### 问题 4: 内存使用过高

**症状**: 缓存使用量 > 50MB，页面卡顿

**解决方案**:
- 点击"清空缓存"释放内存
- 缓存会自动清理过期数据

## 🛠️ 手动调试方法

### 检查缓存状态
```javascript
// 在浏览器控制台执行
console.log(klineCacheService.getCacheStats());
```

### 强制重置缓存服务
```javascript
// 重置到初始状态
klineCacheService.forceReset();
```

### 测试特定币种数据
```javascript
// 测试获取 ETHUSDC 的数据
klineCacheService.getKlines({
  symbol: "ETHUSDC",
  exchange: "binance",
  market: "futures",
  interval: "1h",
  startTime: new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString(),
  endTime: new Date().toISOString()
}).then(console.log).catch(console.error);
```

## 🔄 预防措施

### 定期维护
- 缓存会自动清理过期数据（每5分钟）
- 1分钟K线缓存5分钟，其他缓存30分钟
- 超过1000个缓存条目会自动清理最旧的

### 最佳实践
1. **避免频繁切换时间范围** - 会导致大量缓存失效
2. **关闭不需要的页面** - 减少内存占用
3. **定期清理缓存** - 特别是长时间使用后

## 📊 缓存机制说明

### 缓存策略
- **在线模式**: 优先使用缓存，缓存失效时请求API
- **离线模式**: 仅使用已缓存的数据，不发起网络请求
- **智能合并**: 自动合并重叠的时间段数据

### 缓存层次
1. **内存缓存** - 最近访问的数据
2. **时间范围缓存** - 支持部分覆盖查询
3. **自动刷新** - 定期更新最新的1分钟数据

## 🚨 紧急情况处理

如果所有方法都无效：

1. **硬重置**
```javascript
// 完全销毁并重建缓存服务
klineCacheService.destroy();
// 刷新页面
window.location.reload();
```

2. **清除浏览器存储**
```javascript
// 清除所有本地存储
localStorage.clear();
sessionStorage.clear();
```

3. **重启浏览器** - 清除所有内存状态

## 📞 技术支持

如果问题仍然存在，请收集以下信息：

1. 诊断工具的完整输出
2. 浏览器控制台错误日志
3. 网络面板中的失败请求
4. 问题发生的具体操作步骤

---

**注意**: 缓存诊断工具位于页面右下角，仅在开发/测试环境中显示。生产环境如有问题请联系技术支持。
